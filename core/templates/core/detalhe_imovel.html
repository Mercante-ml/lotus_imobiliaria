{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% load core_tags %}

{% block title %}{{ imovel.titulo }} - Lotus Imobiliária{% endblock %}

{% block content %}

<!-- 1. SEÇÃO DO TÍTULO E BOTÃO VOLTAR -->
<section class="bg-marinho-escuro text-white pt-28 pb-16">
    <div class="container mx-auto px-6">
        {% if last_search_url %}
            <a href="{{ last_search_url }}" class="inline-flex items-center text-cinza-claro hover:text-white mb-6 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                Voltar para a busca
            </a>
        {% else %}
            <a href="{% url 'core:lista_imoveis' %}" class="inline-flex items-center text-cinza-claro hover:text-white mb-6 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                Ver todos os imóveis
            </a>
        {% endif %}
        <div class="text-center">
            <h1 class="font-serif text-4xl md:text-6xl font-bold">{{ imovel.titulo }}</h1>
            <p class="mt-4 text-lg md:text-xl max-w-2xl mx-auto text-cinza-claro/80">
                {{ imovel.tipo_imovel.nome|default:'Imóvel' }} em {{ imovel.bairro.nome|default:'Localização Privilegiada' }}
            </p>
        </div>
    </div>
</section>

<!-- 2. SEÇÃO PRINCIPAL (GRID CORRIGIDO) -->
<section class="py-20 bg-cinza-fundo">
    <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

            <!-- Coluna da Esquerda (Conteúdo Principal) -->
            <div class="lg:col-span-2">
                
                <!-- Galeria com Lightbox -->
                <div id="gallery-detalhe" class="pswp-gallery pswp-gallery--single-column bg-white p-8 rounded-lg shadow-xl mb-12">
                    <h3 class="font-serif text-3xl text-marinho font-bold mb-6">Galeria de Imagens</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {% if imovel.imagem_principal %}
                        <a href="{{ imovel.imagem_principal.url }}" data-pswp-width="{{ imovel.imagem_principal.width }}" data-pswp-height="{{ imovel.imagem_principal.height }}" target="_blank">
                            <img src="{{ imovel.imagem_principal.url }}" alt="Foto principal de {{ imovel.titulo }}" class="w-full h-48 object-cover rounded-lg shadow-md hover:scale-105 transition-transform duration-300">
                        </a>
                        {% endif %}
                        {% for img in imovel.imagens_secundarias.all %}
                            <a href="{{ img.imagem.url }}" data-pswp-width="{{ img.imagem.width }}" data-pswp-height="{{ img.imagem.height }}" target="_blank">
                                <img src="{{ img.imagem.url }}" alt="Galeria de {{ imovel.titulo }}" class="w-full h-48 object-cover rounded-lg shadow-md hover:scale-105 transition-transform duration-300">
                            </a>
                        {% endfor %}
                    </div>
                    {% if not imovel.imagens_secundarias.all and not imovel.imagem_principal %}
                        <p class="text-graphite/70">Este imóvel não possui galeria de imagens.</p>
                    {% endif %}
                </div>

                <!-- Descrição -->
                <div class="bg-white p-8 rounded-lg shadow-xl mb-12">
                    <h3 class="font-serif text-3xl text-marinho font-bold mb-5">Descrição</h3>
                    <div class="prose prose-lg max-w-none text-graphite">
                        {{ imovel.descricao|safe }}
                    </div>
                </div>

                <!-- Características -->
                {% if imovel.caracteristicas.all %}
                <div class="bg-white p-8 rounded-lg shadow-xl mt-12">
                    <h3 class="font-serif text-3xl text-marinho font-bold mb-6">Características do Imóvel</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {% for f in imovel.caracteristicas.all %}
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-ouro mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span class="text-graphite">{{ f.nome }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Coluna da Direita (Barra Lateral) -->
            <aside class="lg:col-span-1 lg:sticky top-28 h-fit">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    {% if imovel.valor %}
                        <p class="font-serif text-4xl text-marinho-claro font-bold">R$ {{ imovel.valor|intcomma }}</p>
                    {% else %}
                        <p class="font-serif text-3xl text-marinho-claro font-bold">Sob Consulta</p>
                    {% endif %}

                    <a href="{{ link_whatsapp }}" target="_blank" class="mt-5 block w-full text-center bg-ouro text-marinho font-medium px-5 py-4 rounded-lg shadow-lg hover:bg-ouro/90 transition duration-300">
                        Agende uma visita
                    </a>

<<<<<<< HEAD
=======
                    {% if user|hasattr_filter:'cliente' %}
                        {% if user.cliente in imovel.favoritos.all %}
                            <a href="{% url 'core:remover_favorito' imovel.id %}" class="mt-3 flex items-center justify-center w-full text-center bg-red-500 text-white font-medium px-5 py-4 rounded-lg shadow-lg hover:bg-red-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                                Remover dos Favoritos
                            </a>
                        {% else %}
                            <a href="{% url 'core:adicionar_favorito' imovel.id %}" class="mt-3 flex items-center justify-center w-full text-center bg-blue-500 text-white font-medium px-5 py-4 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                                Adicionar aos Favoritos
                            </a>
                        {% endif %}
                    {% endif %}

                    <div class="mt-3">
                        <input type="checkbox" id="compare_{{ imovel.id }}" name="compare" value="{{ imovel.id }}" onchange="updateCompare({{ imovel.id }})" {% if imovel.id|stringformat:"s" in request.session.comparar_imoveis %}checked{% endif %}>
                        <label for="compare_{{ imovel.id }}">Comparar</label>
                    </div>

                    <!-- Tabela de Especificações -->
>>>>>>> ccc3a18a88ff6b2aa19ec88d8c4e0d186a48fc02
                    <h3 class="font-serif text-xl text-marinho font-bold mt-6 mb-4 border-t pt-4">Especificações</h3>
                    <div class="space-y-3 text-graphite">
                        {% if imovel.area_util %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Área Útil</span><span class="font-bold">{{ imovel.area_util|intcomma }} m²</span></div>{% endif %}
                        {% if imovel.quartos %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Quartos</span><span class="font-bold">{{ imovel.quartos }}</span></div>{% endif %}
                        {% if imovel.suites %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Suítes</span><span class="font-bold">{{ imovel.suites }}</span></div>{% endif %}
                        {% if imovel.banheiros %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Banheiros</span><span class="font-bold">{{ imovel.banheiros }}</span></div>{% endif %}
                        {% if imovel.vagas %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Vagas</span><span class="font-bold">{{ imovel.vagas }}</span></div>{% endif %}
                        {% if imovel.andar %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Andar</span><span class="font-bold">{{ imovel.andar }}º</span></div>{% endif %}
                        {% if imovel.taxa_condominio %}<div class="flex justify-between border-b pb-2"><span class="font-medium">Condomínio</span><span class="font-bold">R$ {{ imovel.taxa_condominio|intcomma }}</span></div>{% endif %}
                        {% if imovel.iptu %}<div class="flex justify-between border-b pb-2"><span class="font-medium">IPTU (Anual)</span><span class="font-bold">R$ {{ imovel.iptu|intcomma }}</span></div>{% endif %}
                    </div>
                </div>
            </aside>

        </div>
    </div>
</section>

<<<<<<< HEAD
{% endblock %}
=======
<script>
function updateCompare(imovelId) {
    const checkbox = document.getElementById(`compare_${imovelId}`);
    const action = checkbox.checked ? 'add' : 'remove';

    fetch("{% url 'core:update_comparison' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `imovel_id=${imovelId}&action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'ok') {
            console.error('Failed to update comparison list');
        }
    });
}
</script>

{% endblock %}
>>>>>>> ccc3a18a88ff6b2aa19ec88d8c4e0d186a48fc02
