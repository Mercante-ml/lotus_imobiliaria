{% load static %}
{% load core_tags %}
<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}Lotus Imobiliária{% endblock %}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'marinho': '#142048',
                        'marinho-claro': '#293769',
                        'marinho-escuro': '#0F1733',
                        'ouro': '#B48C5A',
                        'cinza-fundo': '#F4F6F9',
                        'cinza-claro': '#E2E8F0',
                        'graphite': '#333F58',
                        'favorito-red': '#E11D48', 
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                        'serif': ['EB Garamond', 'ui-serif', 'Georgia'],
                    }
                }
            },
        }
    </script>
    
    <style>
        .btn-favorito svg { transition: all 0.3s ease; }
        .btn-favorito svg path { fill: transparent; stroke: white; stroke-width: 2; }
        .btn-favorito.ativo svg path { fill: #E11D48; stroke: #E11D48; }
        .btn-favorito:hover svg { transform: scale(1.15); }
        .dropdown-menu { display: none; transform-origin: top right; animation: scale-in 0.1s ease-out forwards; }
        .group:hover .dropdown-menu { display: block; }
        @keyframes scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        {% block extra_head %}{% endblock %}
    </style>
    <link href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.min.css" rel="stylesheet">
</head>
<body class="font-sans bg-cinza-fundo text-graphite antialiased">

    {% get_favorite_ids user as favorite_ids %}
    {{ favorite_ids|json_script:'user-favorites' }}

    <script>
        window.CSRF_TOKEN = "{{ csrf_token }}";
        window.TOGGLE_URL = "{% url 'core:toggle_favorito' %}";
        window.SYNC_URL = "{% url 'core:sync_favoritos' %}";
        window.IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
    </script>

    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            
            <a href="{% url 'core:index' %}" class="flex-shrink-0">
                <img src="{% static 'core/images/logo_lotus.png' %}" alt="Lotus Imobiliária Logo" class="h-[60px] w-auto">
            </a>
            
            <div class="hidden md:flex items-center space-x-8">
                <a href="{% url 'core:lista_imoveis' %}" class="text-marinho hover:text-ouro transition duration-300">Imóveis</a>
                <a href="{% url 'core:sobre' %}" class="text-marinho hover:text-ouro transition duration-300">Sobre Nós</a>
                <a href="{% url 'core:lista_corretores' %}" class="text-marinho hover:text-ouro transition duration-300">Equipa</a>
                <a href="{% url 'core:contato' %}" class="text-marinho hover:text-ouro transition duration-300">Contato</a>
                <a href="{% url 'core:lista_blog' %}" class="text-marinho hover:text-ouro transition duration-300">Blog</a>
            </div>
            
            <div class="hidden md:flex items-center space-x-4">
                
                <a href="#" id="link-favoritos-header" class="text-marinho hover:text-ouro p-2 transition duration-300" title="Meus Favoritos">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </a>

                {% if user.is_authenticated %}
                <div class="relative group py-2">
                    <button class="flex items-center text-marinho hover:text-ouro transition duration-300">
                        <span class="truncate max-w-[150px]">Olá, {{ user.first_name|default:user.email }}</span>
                        <svg class="h-5 w-5 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="dropdown-menu absolute right-0 top-full pt-2 w-48 bg-white rounded-lg shadow-xl z-50 overflow-hidden border">
                        <a href="{% url 'core:minha_conta' %}" class="block px-4 py-3 text-sm text-graphite hover:bg-cinza-fundo hover:text-ouro transition-colors">
                            Minha Conta
                        </a>
                        <a href="#" id="link-favoritos-dropdown" class="block px-4 py-3 text-sm text-graphite hover:bg-cinza-fundo hover:text-ouro transition-colors">
                            Meus Favoritos
                        </a>
                        <a href="{% url 'account_logout' %}" class="block px-4 py-3 text-sm text-red-600 hover:bg-cinza-fundo transition-colors border-t">
                            Sair
                        </a>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'account_login' %}" class="text-marinho hover:text-ouro transition duration-300">
                    Olá, faça seu login
                </a>
                <a href="{% url 'account_signup' %}" class="bg-ouro text-marinho font-medium px-5 py-2.5 rounded-lg shadow-lg hover:bg-ouro/90 transition duration-300 transform hover:scale-105">
                    Criar Conta
                </a>
                {% endif %}
            </div>
            <button class="md:hidden text-marinho">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </nav>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-marinho-escuro text-cinza-claro/70">
        <div class="container mx-auto px-6 py-16">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                
                <div>
                    <a href="{% url 'core:index' %}" class="flex-shrink-0">
                        <img src="{% static 'core/images/logo_lotus.png' %}" alt="Lotus Imobiliária Logo" class="h-12 w-auto">
                    </a>
                    <p class="mt-4 text-sm">
                        O seu espaço de renascimento. Clareza e elegância na busca pelo extraordinário.
                    </p>
                    <p class="mt-2 text-sm">CRECI-GO 123.456-J</p>
                </div>

                <div>
                    <h4 class="font-serif text-lg font-bold text-white">Navegar</h4>
                    <ul class="mt-4 space-y-3 text-sm">
                        <li><a href="{% url 'core:lista_imoveis' %}" class="hover:text-ouro transition-colors">Lançamentos</a></li>
                        <li><a href="{% url 'core:lista_imoveis' %}?finalidade=revenda" class="hover:text-ouro transition-colors">Revenda</a></li>
                        <li><a href="{% url 'core:sobre' %}" class="hover:text-ouro transition-colors">Sobre Nós</a></li>
                        <li><a href="{% url 'core:lista_corretores' %}" class="hover:text-ouro transition-colors">Corretores</a></li>
                        <li><a href="{% url 'core:contato' %}" class="hover:text-ouro transition-colors">Contato</a></li>
                        
                        <li class="pt-3 mt-3 border-t border-cinza-claro/10">
                            <a href="{% url 'core:termos_de_uso' %}" class="hover:text-ouro transition-colors">Termos de Uso</a>
                        </li>
                        <li>
                            <a href="{% url 'core:lgpd' %}" class="hover:text-ouro transition-colors">Política de Privacidade (LGPD)</a>
                        </li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-serif text-lg font-bold text-white">Contato</h4>
                    <ul class="mt-4 space-y-3 text-sm">
                        <li>(62) 98250-1403</li>
                        <li>contato@lotusimob.com.br</li>
                        <li>Rua C-259, 519 - Setor Nova Suiça, Goiânia - GO</li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-serif text-lg font-bold text-white">Siga-nos</h4>
                    <div class="flex space-x-4 mt-4">
                        <a href="#" class="hover:text-ouro transition-colors" aria-label="Instagram">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.148 3.225-1.664 4.771-4.919 4.919-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.699-4.919-4.92-.058-1.265-.07-1.646-.07-4.85s.012-3.584.07-4.85C2.28 3.856 3.796 2.309 7.05 2.163 8.316 2.105 8.696 2.093 12 2.093m0-2.093c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.059 1.689.073 4.948.073s3.667-.014 4.947-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.948-.073h.001z" /><path d="M12 6.848c-2.848 0-5.152 2.304-5.152 5.152s2.304 5.152 5.152 5.152 5.152-2.304 5.152-5.152S14.848 6.848 12 6.848zm0 8.303c-1.742 0-3.15-1.408-3.15-3.15s1.408-3.15 3.15-3.15 3.15 1.408 3.15 3.15-1.408 3.15-3.15 3.15z" /><path d="M18.802 6.116c-.596 0-1.08.484-1.08 1.08s.484 1.08 1.08 1.08 1.08-.484 1.08-1.08-.483-1.08-1.08-1.08z" /></svg>
                        </a>
                        <a href="#" class="hover:text-ouro transition-colors" aria-label="Twitter">
                            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </a>
                    </div>
                </div>

            </div>

            <div class="mt-12 border-t border-cinza-claro/10 pt-8 text-center text-sm">
                <p>&copy; {% now "Y" %} Lotus Imobiliária. Todos os direitos reservados.</p>
                <p class="mt-1">Desenvolvido com Django e <span class="text-ouro">&hearts;</span></p>
            </div>
        </div>
    </footer>
    {% block extra_js %}{% endblock %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const FAVORITES_KEY = 'lotus_favoritos';
        const IS_LOGGED_IN = window.IS_AUTHENTICATED;

        function getLocalFavorites() {
            const favs = localStorage.getItem(FAVORITES_KEY);
            return favs ? JSON.parse(favs) : [];
        }

        function saveLocalFavorites(favorites) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(new Set(favorites))));
        }

        async function syncFavoritesWithServer() {
            const localFavorites = getLocalFavorites();
            if (localFavorites.length > 0) {
                try {
                    const response = await fetch(window.SYNC_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        },
                        body: JSON.stringify({ ids: localFavorites })
                    });
                    const data = await response.json();
                    if (data.status === 'success' && data.server_favorites) {
                        saveLocalFavorites(data.server_favorites.map(String));
                        syncUI();
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar favoritos no login:', error);
                }
            }
        }

        async function toggleServerFavorite(imovelId, action) {
            if (!IS_LOGGED_IN) return;
            try {
                await fetch(window.TOGGLE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    body: JSON.stringify({ id: imovelId, action: action })
                });
            } catch (error) {
                console.error('Falha ao favoritar:', error);
            }
        }

        function handleFavoriteClick(button) {
            const imovelId = button.dataset.imovelId;
            let favorites = getLocalFavorites();
            const isFavorited = favorites.includes(imovelId);
            
            button.classList.toggle('ativo', !isFavorited);

            if (isFavorited) {
                favorites = favorites.filter(id => id !== imovelId);
                toggleServerFavorite(imovelId, 'remove');
            } else {
                favorites.push(imovelId);
                toggleServerFavorite(imovelId, 'add');
            }
            saveLocalFavorites(favorites);

            const paginaFavoritos = document.getElementById('pagina-favoritos');
            if (paginaFavoritos && isFavorited) {
                const card = button.closest('.imovel-card');
                if (card) {
                    card.style.transition = 'opacity 0.4s';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        if (getLocalFavorites().length === 0) {
                            document.getElementById('sem-favoritos').style.display = 'block';
                        }
                    }, 400);
                }
            }
        }

        document.body.addEventListener('click', e => {
            const button = e.target.closest('.btn-favorito');
            if (button) {
                e.preventDefault();
                handleFavoriteClick(button);
            }
        });

        function goToFavorites(e) {
            e.preventDefault();
            if (IS_LOGGED_IN) {
                window.location.href = "{% url 'core:favoritos' %}";
            } else {
                const favorites = getLocalFavorites();
                const url = new URL("{% url 'core:favoritos' %}", window.location.origin);
                if (favorites.length > 0) {
                    url.searchParams.set('ids', favorites.join(','));
                }
                window.location.href = url.href;
            }
        }

        document.getElementById('link-favoritos-header')?.addEventListener('click', goToFavorites);
        document.getElementById('link-favoritos-dropdown')?.addEventListener('click', goToFavorites);

        function syncUI() {
            const favorites = getLocalFavorites();
            document.querySelectorAll('.btn-favorito').forEach(button => {
                button.classList.toggle('ativo', favorites.includes(button.dataset.imovelId));
            });
        }

        function initializeFavorites() {
            if (IS_LOGGED_IN) {
                const serverFavsData = document.getElementById('user-favorites');
                if (serverFavsData) {
                    const serverFavorites = JSON.parse(serverFavsData.textContent).map(String);
                    const localFavorites = getLocalFavorites();
                    const combined = Array.from(new Set([...serverFavorites, ...localFavorites]));
                    saveLocalFavorites(combined);
                    if (localFavorites.length > 0) {
                        syncFavoritesWithServer();
                    }
                }
            }
            syncUI();
        }

        initializeFavorites();
    });
    </script>
    </body>
</html>