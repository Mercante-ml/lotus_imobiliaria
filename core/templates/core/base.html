{% load static %}
<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}Lotus Imobiliária{% endblock %}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'marinho': '#142048',
                        'marinho-claro': '#293769',
                        'marinho-escuro': '#0F1733',
                        'ouro': '#B48C5A',
                        'cinza-fundo': '#F4F6F9',
                        'cinza-claro': '#E2E8F0',
                        'graphite': '#333F58',
                        'favorito-red': '#E11D48', 
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                        'serif': ['EB Garamond', 'ui-serif', 'Georgia'],
                    }
                }
            },
        }
    </script>
    
    <style>
        .btn-favorito svg { transition: all 0.3s ease; }
        .btn-favorito svg path { fill: transparent; stroke: white; stroke-width: 2; }
        .btn-favorito.ativo svg path { fill: #E11D48; stroke: #E11D48; }
        .btn-favorito:hover svg { transform: scale(1.15); }
        .dropdown-menu { display: none; transform-origin: top right; animation: scale-in 0.1s ease-out forwards; }
        .group:hover .dropdown-menu { display: block; }
        @keyframes scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        {% block extra_head %}{% endblock %}
    </style>
    <link href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.min.css" rel="stylesheet">
</head>
<body class="font-sans bg-cinza-fundo text-graphite antialiased">

    <script>
        window.CSRF_TOKEN = "{{ csrf_token }}";
        window.SYNC_URL = "{% url 'core:sync_favoritos' %}";
        window.IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
    </script>

    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            
            <a href="{% url 'core:index' %}" class="flex-shrink-0">
                <img src="{% static 'core/images/logo_lotus.png' %}" alt="Lotus Imobiliária Logo" class="h-[60px] w-auto">
            </a>
            
            <div class="hidden md:flex items-center space-x-8">
                <a href="{% url 'core:lista_imoveis' %}" class="text-marinho hover:text-ouro transition duration-300">Imóveis</a>
                <a href="{% url 'core:sobre' %}" class="text-marinho hover:text-ouro transition duration-300">Sobre Nós</a>
                <a href="{% url 'core:lista_corretores' %}" class="text-marinho hover:text-ouro transition duration-300">Equipa</a>
                <a href="{% url 'core:contato' %}" class="text-marinho hover:text-ouro transition duration-300">Contato</a>
            </div>
            
            <div class="hidden md:flex items-center space-x-4">
                
                <a href="#" id="link-favoritos-header" class="text-marinho hover:text-ouro p-2 transition duration-300" title="Meus Favoritos">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </a>

                {% if user.is_authenticated %}
                <div class="relative group py-2">
                    <button class="flex items-center text-marinho hover:text-ouro transition duration-300">
                        <span class="truncate max-w-[150px]">Olá, {{ user.first_name|default:user.email }}</span>
                        <svg class="h-5 w-5 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="dropdown-menu absolute right-0 top-full pt-2 w-48 bg-white rounded-lg shadow-xl z-50 overflow-hidden border">
                        <a href="{% url 'core:minha_conta' %}" class="block px-4 py-3 text-sm text-graphite hover:bg-cinza-fundo hover:text-ouro transition-colors">
                            Minha Conta
                        </a>
                        <a href="#" id="link-favoritos-dropdown" class="block px-4 py-3 text-sm text-graphite hover:bg-cinza-fundo hover:text-ouro transition-colors">
                            Meus Favoritos
                        </a>
                        <a href="{% url 'account_logout' %}" class="block px-4 py-3 text-sm text-red-600 hover:bg-cinza-fundo transition-colors border-t">
                            Sair
                        </a>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'account_login' %}" class="text-marinho hover:text-ouro transition duration-300">
                    Olá, faça seu login
                </a>
                <a href="{% url 'account_signup' %}" class="bg-ouro text-marinho font-medium px-5 py-2.5 rounded-lg shadow-lg hover:bg-ouro/90 transition duration-300 transform hover:scale-105">
                    Criar Conta
                </a>
                {% endif %}
            </div>
            <button class="md:hidden text-marinho">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </nav>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-marinho-escuro text-cinza-claro/70">
        <div class="container mx-auto px-6 py-16"> ... </div>
    </footer>

    {% block extra_js %}{% endblock %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const FAVORITES_KEY = 'lotus_favoritos';
        const IS_LOGGED_IN = window.IS_AUTHENTICATED;

        // --- Funções de Ajuda (LocalStorage) ---
        function getLocalFavorites() {
            return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        }
        function saveLocalFavorites(favorites) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        }
        function clearLocalFavorites() {
            localStorage.removeItem(FAVORITES_KEY);
        }

        // --- Função de Sincronização (A Mágica) ---
        async function syncFavoritesWithServer(ids) {
            // Envia os IDs para o Django
            try {
                await fetch(window.SYNC_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    body: JSON.stringify({ ids: ids })
                });
            } catch (error) {
                console.error('Falha ao sincronizar favoritos:', error);
            }
        }

        // --- Função Principal de Clique ---
        async function handleFavoriteClick(button) {
            const imovelId = button.dataset.imovelId;
            let favorites = getLocalFavorites();
            const index = favorites.indexOf(imovelId);
            let foiAdicionado;

            if (index > -1) {
                // Remove
                favorites.splice(index, 1);
                foiAdicionado = false;
            } else {
                // Adiciona
                favorites.push(imovelId);
                foiAdicionado = true;
            }
            
            // Atualiza o estado visual IMEDIATAMENTE
            button.classList.toggle('ativo', foiAdicionado);

            if (IS_LOGGED_IN) {
                // Se está logado, salva no localStorage E no servidor
                saveLocalFavorites(favorites); // Salva local para a UI ficar consistente
                await syncFavoritesWithServer(favorites); // Envia a lista COMPLETA
            } else {
                // Se anônimo, salva SÓ no localStorage
                saveLocalFavorites(favorites);
            }

            // Lógica para remover o card da página de favoritos (se existir)
            const paginaFavoritos = document.getElementById('pagina-favoritos');
            if (paginaFavoritos && !foiAdicionado) {
                const card = button.closest('.imovel-card');
                if (card) {
                    card.style.transition = 'opacity 0.4s';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 400);
                }
            }
        }

        // --- Event Listeners ---
        document.body.addEventListener('click', function(e) {
            const button = e.target.closest('.btn-favorito');
            if (button) {
                e.preventDefault();
                handleFavoriteClick(button);
            }
        });

        // --- Links de "Meus Favoritos" (Header e Dropdown) ---
        function goToFavorites(e) {
            e.preventDefault();
            if (IS_LOGGED_IN) {
                // Se logado, vai para a URL base (a view vai ler do perfil)
                window.location.href = "{% url 'core:favoritos' %}";
            } else {
                // Se anônimo, constrói a URL com os IDs (método antigo)
                const favorites = getLocalFavorites();
                let url = "{% url 'core:favoritos' %}";
                if (favorites.length > 0) {
                    url += `?ids=${favorites.join(',')}`;
                }
                window.location.href = url;
            }
        }
        document.getElementById('link-favoritos-header')?.addEventListener('click', goToFavorites);
        document.getElementById('link-favoritos-dropdown')?.addEventListener('click', goToFavorites);

        // --- Inicialização ---
        
        // 1. Sincroniza ao carregar a página (se logado)
        if (IS_LOGGED_IN) {
            const localFavs = getLocalFavorites();
            if (localFavs.length > 0) {
                // Se o usuário logou e tem favoritos anônimos, envia
                syncFavoritesWithServer(localFavs).then(() => {
                    // (Opcional: poderia limpar o local storage,
                    // mas é melhor manter para a UI ser rápida)
                });
            }
        }
        
        // 2. Atualiza os ícones (lendo do localStorage, que é a fonte da verdade)
        // (Em um sistema 100% perfeito, se logado, nós buscaríamos os favoritos
        // do servidor e preencheríamos o localStorage, mas isso é mais complexo)
        const favorites = getLocalFavorites();
        document.querySelectorAll('.btn-favorito').forEach(button => {
            if (favorites.includes(button.dataset.imovelId)) {
                button.classList.add('ativo');
            } else {
                button.classList.remove('ativo');
            }
        });
    });
    </script>
    </body>
</html>